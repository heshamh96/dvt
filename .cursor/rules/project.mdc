# DVT Project Rules

**Description**: Global project rules that apply to all work in dvt-core.

## Repository Context

- **Repository**: `git@github.com:heshamh96/dvt.git`
- **Default Branch**: `dev` (all development happens here)
- **Production**: `master`
- **Branch Flow**: dev → uat → prod (via PRs)
- **Rebase Strategy**: Built on dbt-core; preserve ability to rebase `dev` onto `upstream/main`

## Project Structure

```
dvt-core/
├── core/                    # Main package source
│   ├── dvt/                 # DVT Python package
│   │   ├── cli/             # CLI commands (Click-based)
│   │   ├── config/          # Configuration loading
│   │   ├── task/            # Task implementations
│   │   ├── graph/           # DAG construction
│   │   ├── contracts/       # Dataclass definitions
│   │   ├── parser/          # YAML/SQL parsing
│   │   └── ...
│   ├── pyproject.toml       # Package configuration
│   └── hatch.toml           # Hatch build/test config
├── tests/
│   ├── unit/                # Unit tests (pure Python)
│   └── functional/          # Integration tests (needs DB)
├── docs/                    # Documentation
│   └── dvt_implementation_plan.md  # Canonical DVT RULES
├── hesham_mind/
│   └── dvt_rules.md         # Detailed DVT rules
└── .cursor/
    ├── rules/               # Agent rules
    └── prompts/             # Development prompts
```

## Development Commands

```bash
cd core
hatch run setup              # Setup dev environment
hatch run unit-tests         # Run unit tests
hatch run integration-tests  # Run functional tests
hatch run lint               # Run linters
hatch run code-quality       # All pre-commit hooks
```

## Key Principles

1. **DVT RULES are canonical** - Always reference `docs/dvt_implementation_plan.md`
2. **Pushdown first** - Prefer adapter pushdown over federation
3. **dbt compatibility** - Maintain compatibility with dbt-core patterns
4. **Rebase safety** - Changes must be rebaseable onto upstream dbt-core
5. **Test coverage** - Add tests for new functionality

## Configuration Files

| File | Location | Purpose |
|------|----------|---------|
| `dbt_project.yml` | Project root | Project configuration |
| `profiles.yml` | `~/.dvt/` | Database connections |
| `computes.yml` | `~/.dvt/` | Spark compute configs |
| `mdm.duckdb` | `~/.dvt/data/` | MDM database |

## Resolution Hierarchies

### Target Resolution (Rule 2)
CLI `--target` > model config > profiles.yml default

### Compute Resolution (Rule 1)
CLI `--compute` > model config > computes.yml default

### Execution Path (Rule 3)
- Same target as upstreams → Adapter pushdown
- Different target from any upstream → Spark federation

## Code Style

- **Line length**: 99 characters (black)
- **Type hints**: Required for new code
- **Docstrings**: For public APIs
- **Tests**: Required for new functionality

## Agent Selection

Choose the appropriate agent based on your task:

| Task | Agent |
|------|-------|
| CLI commands | `dev-team-backend` |
| Architecture/design | `dev-team-architecture` |
| Federation engine | `dev-team-federation` |
| Database adapters | `dev-team-adapters` |
| MDM/types | `dev-team-mdm-types` |
| Testing | `dev-team-qa` |
| CI/CD | `dev-team-deploy` |
| Documentation | `dev-team-docs` |
| dbt compatibility testing | `test-team-data-engineer` |
| Path/file verification | `test-team-technical-qa` |
| Edge case testing | `test-team-negative-tester` |
