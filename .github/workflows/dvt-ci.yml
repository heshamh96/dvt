# DVT CI/CD Workflow
# Runs tests and code quality checks on dev, uat, and prod branches
# This workflow ensures code quality before promoting between environments

name: DVT CI/CD

on:
  push:
    branches:
      - dev
      - uat
      - prod
  pull_request:
    branches:
      - dev
      - uat
      - prod
  workflow_dispatch:

permissions: read-all

# Cancel previous workflows for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ contains(github.event_name, 'pull_request') && github.event.pull_request.head.ref || github.ref }}
  cancel-in-progress: true

defaults:
  run:
    shell: bash

env:
  # Number of parallel processes for integration testing
  PYTHON_INTEGRATION_TEST_WORKERS: 5

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run code quality checks
        run: |
          echo "Running code quality checks..."
          # Add your code quality checks here (flake8, black, mypy, etc.)
          # Example:
          # flake8 core/dvt
          # black --check core/dvt
          # mypy core/dvt

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          echo "Running unit tests..."
          pytest tests/unit -v --cov=core/dvt --cov-report=xml

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        if: always()
        with:
          file: ./coverage.xml
          flags: unit
          name: unit-tests

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run integration tests
        run: |
          echo "Running integration tests with Python ${{ matrix.python-version }}..."
          pytest tests/integration -v -n ${{ env.PYTHON_INTEGRATION_TEST_WORKERS }}

  build-package:
    name: Build Package
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build package
        run: |
          echo "Building DVT package..."
          python -m build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-packages
          path: dist/
          retention-days: 7

  branch-validation:
    name: Branch Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate branch strategy
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "Validating branch: $BRANCH"
          
          # Check if branch is one of our expected branches
          if [[ "$BRANCH" != "dev" && "$BRANCH" != "uat" && "$BRANCH" != "prod" ]]; then
            echo "Warning: Branch '$BRANCH' is not dev, uat, or prod"
          fi
          
          # For PRs, validate source and target branches
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            SOURCE="${{ github.head_ref }}"
            TARGET="${{ github.base_ref }}"
            echo "PR: $SOURCE → $TARGET"
            
            # Validate branch promotion flow
            if [[ "$SOURCE" == "dev" && "$TARGET" == "uat" ]]; then
              echo "✓ Valid: dev → uat"
            elif [[ "$SOURCE" == "uat" && "$TARGET" == "prod" ]]; then
              echo "✓ Valid: uat → prod"
            elif [[ "$SOURCE" == "dev" && "$TARGET" == "dev" ]]; then
              echo "✓ Valid: feature branch → dev"
            else
              echo "⚠ Warning: Unusual branch flow ($SOURCE → $TARGET)"
            fi
          fi

  # Only run on prod branch
  production-checks:
    name: Production Checks
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/prod'
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Production readiness checks
        run: |
          echo "Running production readiness checks..."
          # Add production-specific checks here
          # Examples:
          # - Check for TODO/FIXME comments
          # - Verify all tests pass
          # - Check for security vulnerabilities
          # - Validate configuration files

  # Summary job that depends on all other jobs
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, integration-tests, build-package, branch-validation]
    if: always()

    steps:
      - name: Check job results
        run: |
          echo "## CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Package | ${{ needs.build-package.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch Validation | ${{ needs.branch-validation.result }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.production-checks.result }}" != "" ]; then
            echo "| Production Checks | ${{ needs.production-checks.result }} |" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Fail if any required job failed
          if [ "${{ needs.code-quality.result }}" == "failure" ] || \
             [ "${{ needs.unit-tests.result }}" == "failure" ] || \
             [ "${{ needs.integration-tests.result }}" == "failure" ] || \
             [ "${{ needs.build-package.result }}" == "failure" ]; then
            echo "❌ CI checks failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
